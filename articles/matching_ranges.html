<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of matchRanges • nullranges</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Overview of matchRanges">
<meta property="og:description" content="nullranges">
<meta property="og:image" content="https://nullranges.github.io/nullranges/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nullranges</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.19</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to nullranges</a>
    </li>
    <li>
      <a href="../articles/matching_ranges.html">Overview of matchRanges</a>
    </li>
    <li>
      <a href="../articles/matching_granges.html">Case study I: CTCF enrichment</a>
    </li>
    <li>
      <a href="../articles/matching_ginteractions.html">Case study II: CTCF orientation</a>
    </li>
    <li>
      <a href="../articles/segmented_boot_ranges.html">Segmented block bootstrap</a>
    </li>
    <li>
      <a href="../articles/unseg_boot_ranges.html">Un-segmented block bootstrap</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nullranges/nullranges/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="matching_ranges_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of matchRanges</h1>
                        <h4 class="author">Eric S. Davis</h4>
            
            <h4 class="date">06/23/2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nullranges/nullranges/blob/master/vignettes/matching_ranges.Rmd"><code>vignettes/matching_ranges.Rmd</code></a></small>
      <div class="hidden name"><code>matching_ranges.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>We often want to know the causal relationship between one or more genomic features. Most statistical tests incorrectly assume that features are randomly distributed across the genome. In fact many features break this assumption because they covary or have different underlying distributions after being subset by another feature. It is therefore critical to isolate the feature of interest by assembling a null set that is matched for confounding covariates. To address this question the <code>nullranges</code> package implements <code><a href="../reference/matchRanges.html">matchRanges()</a></code>, an efficient and convenient tool for selecting a covariate-matched set of null hypothesis ranges from a pool of background ranges within the Bioconductor framework.</p>
<p>In this vignette, we provide an overview of <code><a href="../reference/matchRanges.html">matchRanges()</a></code> and its associated functions. We start with a simulated example generated with the utility function <code><a href="../reference/makeExampleMatchedDataSet.html">makeExampleMatchedDataSet()</a></code>. We also provide an overview of the class struture and a guide for choosing among the supported matching methods. To see <code>matchedRanges()</code> used in real biological examples, visit the <a href="matching_granges.html">Case study I: CTCF enrichment</a>, and <a href="matching_ginteractions.html">Case study II: CTCF orientation</a> vignettes.</p>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-1-1.png"><!-- --></p>
</div>
<div id="using-matchranges" class="section level2">
<h2 class="hasAnchor">
<a href="#using-matchranges" class="anchor"></a>Using <code>matchRanges()</code>
</h2>
<p>We will use a simulated data set to demonstrate matching across covarying features:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nullranges/nullranges">nullranges</a></span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeExampleMatchedDataSet.html">makeExampleMatchedDataSet</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'GRanges'</span><span class="op">)</span>
<span class="va">x</span></code></pre></div>
<pre><code>## GRanges object with 10500 ranges and 3 metadata columns:
##           seqnames      ranges strand |  feature1  feature2    feature3
##              &lt;Rle&gt;   &lt;IRanges&gt;  &lt;Rle&gt; | &lt;logical&gt; &lt;numeric&gt; &lt;character&gt;
##       [1]     chr1       1-100      * |      TRUE   2.87905           c
##       [2]     chr1       2-101      * |      TRUE   3.53965           c
##       [3]     chr1       3-102      * |      TRUE   7.11742           c
##       [4]     chr1       4-103      * |      TRUE   4.14102           a
##       [5]     chr1       5-104      * |      TRUE   4.25858           c
##       ...      ...         ...    ... .       ...       ...         ...
##   [10496]     chr1 10496-10595      * |     FALSE   1.23578           b
##   [10497]     chr1 10497-10596      * |     FALSE   1.69671           a
##   [10498]     chr1 10498-10597      * |     FALSE   6.11140           a
##   [10499]     chr1 10499-10598      * |     FALSE   2.21657           d
##   [10500]     chr1 10500-10599      * |     FALSE   5.33003           b
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<p>Our simulated dataset has 3 features: logical <code>feature1</code>, numeric <code>feature2</code>, and character/factor <code>feature3</code>. We can use <code><a href="../reference/matchRanges.html">matchRanges()</a></code> to compare ranges where <code>feature1</code> is <code>TRUE</code> to ranges where <code>feature1</code> is <code>FALSE</code>, matched by <code>feature2</code> and/or <code>feature3</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mgr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchRanges.html">matchRanges</a></span><span class="op">(</span>focal <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   pool <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   covar <span class="op">=</span> <span class="op">~</span><span class="va">feature2</span> <span class="op">+</span> <span class="va">feature3</span><span class="op">)</span>
<span class="va">mgr</span></code></pre></div>
<pre><code>## MatchedGRanges object with 500 ranges and 3 metadata columns:
##         seqnames      ranges strand |  feature1  feature2    feature3
##            &lt;Rle&gt;   &lt;IRanges&gt;  &lt;Rle&gt; | &lt;logical&gt; &lt;numeric&gt; &lt;character&gt;
##     [1]     chr1   4373-4472      * |     FALSE  8.959578           d
##     [2]     chr1   9740-9839      * |     FALSE  0.959336           e
##     [3]     chr1   7755-7854      * |     FALSE  2.107003           c
##     [4]     chr1   8266-8365      * |     FALSE  6.231860           d
##     [5]     chr1   4298-4397      * |     FALSE  6.955316           c
##     ...      ...         ...    ... .       ...       ...         ...
##   [496]     chr1   2443-2542      * |     FALSE   1.12276           b
##   [497]     chr1   2455-2554      * |     FALSE   3.38518           c
##   [498]     chr1   1285-1384      * |     FALSE   1.58546           c
##   [499]     chr1 10137-10236      * |     FALSE   9.39272           c
##   [500]     chr1   6119-6218      * |     FALSE  10.22412           c
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<p>The resulting <code>MatchedGRanges</code> object is a set of null hypothesis ranges selected from our <code>pool</code> of options that is the same length as our input <code>focal</code> ranges and matched for <code>covar</code> features 2 and 3. These matched ranges print and behave just as normal <code>GRanges</code> would:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/GenomicRanges">GenomicRanges</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<pre><code>## MatchedGRanges object with 500 ranges and 3 metadata columns:
##         seqnames      ranges strand |  feature1  feature2    feature3
##            &lt;Rle&gt;   &lt;IRanges&gt;  &lt;Rle&gt; | &lt;logical&gt; &lt;numeric&gt; &lt;character&gt;
##     [1]     chr1     511-610      * |     FALSE  5.545186           c
##     [2]     chr1     513-612      * |     FALSE  2.221684           b
##     [3]     chr1     534-633      * |     FALSE  1.563458           b
##     [4]     chr1     565-664      * |     FALSE  0.932659           c
##     [5]     chr1     577-676      * |     FALSE  3.256908           c
##     ...      ...         ...    ... .       ...       ...         ...
##   [496]     chr1 10377-10476      * |     FALSE  0.795032           c
##   [497]     chr1 10380-10479      * |     FALSE  0.977984           b
##   [498]     chr1 10409-10508      * |     FALSE  3.662119           c
##   [499]     chr1 10455-10554      * |     FALSE  6.815473           c
##   [500]     chr1 10483-10582      * |     FALSE  3.724147           c
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths</code></pre>
<p>We can change the <code>type</code> argument of <code>makeExampleMatchedDataSet</code> to input data.frames, data.tables, DataFrames, GRanges and GInteractions objects - all of which work as inputs for <code>matchRanges</code>. These produce either <code>MatchedDataFrame</code>, <code>MatchedGRanges</code>, or <code>MatchedGInteractions</code> objects. For more information about the <code>Matched</code> class structure and available methods, see the <a href="#class-structure">Class structure</a> section below or the help documentation for each class, <code><a href="../reference/MatchedDataFrame-class.html">?MatchedDataFrame</a></code>, <code><a href="../reference/MatchedGRanges-class.html">?MatchedGRanges</a></code>, or <code><a href="../reference/MatchedGInteractions-class.html">?MatchedGInteractions</a></code>.</p>
<div id="assessing-quality-of-matching" class="section level3">
<h3 class="hasAnchor">
<a href="#assessing-quality-of-matching" class="anchor"></a>Assessing quality of matching</h3>
<p>We can assess the quality of <code>Matched</code> classes with <code><a href="../reference/overview.html">overview()</a></code>, <code><a href="../reference/plotCovariate.html">plotCovariate()</a></code>, and <code><a href="../reference/plotPropensity.html">plotPropensity()</a></code>. <code><a href="../reference/overview.html">overview()</a></code> provides a quick assessment of overall matching quality by reporting the mean and standard deviation for covariates and propensity scores of the focal, pool, matched, and unmatched sets. It also reports the mean difference in focal-matched sets:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/overview.html">overview</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<pre><code>## MatchedGRanges object: 
##        set     N feature2.mean feature2.sd feature3.a feature3.b feature3.c
##      focal   500           4.1         1.9         66        157        206
##    matched   500           4.5         2.7         34        160        234
##       pool 10000           6.0         3.4       4248       3121       1117
##  unmatched  9500           6.1         3.5       4214       2961        883
##  feature3.d feature3.e ps.mean ps.sd
##          49         22   0.100 0.076
##          53         19   0.110 0.078
##         992        522   0.045 0.051
##         939        503   0.041 0.047
## --------
## focal - matched: 
##  feature2.mean feature2.sd feature3.a feature3.b feature3.c feature3.d
##          -0.42       -0.84         32         -3        -28         -4
##  feature3.e ps.mean   ps.sd
##           3 -0.0057 -0.0019</code></pre>
<p>Visualizing propensity scores can show how well sets were matched overall:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotPropensity.html">plotPropensity</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-6-1.png"><!-- --></p>
<p>The distributions of features can be visualized in each set with <code><a href="../reference/plotCovariate.html">plotCovariate()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotCovariate.html">plotCovariate</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-7-1.png"><!-- --></p>
<p>Since these functions return ggplots, <code>patchwork</code> can be used to visualize all covariates like this:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="../reference/covariates.html">covariates</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>, <span class="va">plotCovariate</span>, x<span class="op">=</span><span class="va">mgr</span>, sets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'f'</span>, <span class="st">'m'</span>, <span class="st">'p'</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span><span class="st">'/'</span>, <span class="va">plots</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-8-1.png"><!-- --></p>
<p>By default, continuous features are plotted as density line plots while categorical features are plotted as stacked bar plots. All sets are also shown by default. Defaults can be overridden by setting the <code>type</code> and <code>sets</code> arguments.</p>
</div>
<div id="accessing-matched-data" class="section level3">
<h3 class="hasAnchor">
<a href="#accessing-matched-data" class="anchor"></a>Accessing matched data</h3>
<p>Custom plots can be made by extracting data from the <code>Matched</code> object:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/matchedData.html">matchedData</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<pre><code>##        id feature2 feature3         ps       set
##     1:  1 2.879049        c 0.21095908     focal
##     2:  1 3.539645        c 0.19210984     focal
##     3:  1 7.117417        c 0.11193396     focal
##     4:  1 4.141017        a 0.01771986     focal
##     5:  1 4.258575        c 0.17308581     focal
##    ---                                          
## 20496:  0 1.235781        b 0.08945367 unmatched
## 20497:  0 1.696712        a 0.02707977 unmatched
## 20498:  0 6.111404        a 0.01255772 unmatched
## 20499:  0 2.216575        d 0.07578989 unmatched
## 20500:  0 5.330029        b 0.04535856 unmatched</code></pre>
<p>Attributes of the <code>Matched</code> object can be extracted with the following accessor functions:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/covariates.html">covariates</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>
<span class="fu"><a href="../reference/method.html">method</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>
<span class="fu"><a href="../reference/withReplacement.html">withReplacement</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "feature2" "feature3"
## [1] "rejection"
## [1] FALSE</code></pre>
<p>Each set can also be extracted with the following accessor functions:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/focal.html">focal</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/pool.html">pool</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/matched.html">matched</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/unmatched.html">unmatched</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "GRanges object with 500 ranges and 3 metadata columns"
## [1] "GRanges object with 10000 ranges and 3 metadata columns"
## [1] "GRanges object with 500 ranges and 3 metadata columns"
## [1] "GRanges object with 9500 ranges and 3 metadata columns"</code></pre>
<p>The <code><a href="../reference/indices.html">indices()</a></code> function can be used to find the original indices for each set. For example, <code><a href="../reference/indices.html">indices(x, set="matched")</a></code> will supply the indices from the <code>pool</code> set that corresponds to the <code>matched</code> set. In fact, <code><a href="../reference/matched.html">matched(x)</a></code> is a convenient wrapper around <code>pool(x)[indices(x, set='matched')</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/matched.html">matched</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>, <span class="fu"><a href="../reference/pool.html">pool</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">mgr</span>, set <span class="op">=</span> <span class="st">'matched'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="choosing-the-method-parameter" class="section level2">
<h2 class="hasAnchor">
<a href="#choosing-the-method-parameter" class="anchor"></a>Choosing the <code>method</code> parameter</h2>
<p>There are currently 3 available methods for selecting a matched set:</p>
<ol style="list-style-type: decimal">
<li><p>Nearest-neighbor matching with replacement</p></li>
<li><p>Rejection sampling with/without replacement</p></li>
<li><p>Stratified sampling with/without replacement</p></li>
</ol>
<p>Currently, nearest-neighbor matching without replacement is not implemented, but stratified sampling without replacement is a fairly good substitute.</p>
<div id="nearest-neighbor-matching" class="section level3">
<h3 class="hasAnchor">
<a href="#nearest-neighbor-matching" class="anchor"></a>Nearest-neighbor matching</h3>
<p>Attempts to find the nearest neighbor for each range by using a rolling-join (as implemented in the <code>data.table</code> package) between <code>focal</code> and <code>pool</code> propensity scores.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mgr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchRanges.html">matchRanges</a></span><span class="op">(</span>focal <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   pool <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   covar <span class="op">=</span> <span class="op">~</span><span class="va">feature2</span> <span class="op">+</span> <span class="va">feature3</span>,
                   method <span class="op">=</span> <span class="st">'nearest'</span>,
                   replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/overview.html">overview</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotPropensity.html">plotPropensity</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-13-1.png"><!-- --></p>
<p>This method is best if you have a very large dataset because it is usually the fastest matching method. However, because sampling is done with replacement the user should be careful to assess the number of duplicate ranges pulled. This can be done fairly easily using the <code><a href="../reference/indices.html">indices()</a></code> function:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Total number of duplicated indices</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># used more than once</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># used more than twice</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># used more than thrice</span></code></pre></div>
<pre><code>## [1] 59
## [1] 51
## [1] 8
## [1] 0</code></pre>
</div>
<div id="rejection-sampling" class="section level3">
<h3 class="hasAnchor">
<a href="#rejection-sampling" class="anchor"></a>Rejection sampling</h3>
<p>Uses a probability-based approach to select options in the <code>pool</code> that distributionally match the <code>focal</code> set based on propensity scores. If <code>method</code> or <code>replace</code> is not supplied, the default values are rejection sampling without replacement.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mgr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchRanges.html">matchRanges</a></span><span class="op">(</span>focal <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   pool <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   covar <span class="op">=</span> <span class="op">~</span><span class="va">feature2</span> <span class="op">+</span> <span class="va">feature3</span>,
                   method <span class="op">=</span> <span class="st">'rejection'</span>,
                   replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/overview.html">overview</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotPropensity.html">plotPropensity</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-15-1.png"><!-- --></p>
<p>Rejection sampling is typically the fastest available matching method. Therefore, it is ideal to use on large datasets when sampling without replacement is important. However, this method can be unstable, particularly when the pool set is not much larger than the focal set. In those cases, the best method to use is stratified sampling.</p>
</div>
<div id="stratified-sampling" class="section level3">
<h3 class="hasAnchor">
<a href="#stratified-sampling" class="anchor"></a>Stratified sampling</h3>
<p>Performs iterative sampling on increasingly large bins of data. <code>focal</code> and <code>pool</code> propensity scores are binned by their value with high granularity, options are randomly selected (with or without replacement) within each bin and subsequently removed from the pool of available options. This procedure is repeated, decreasing the number of bins (and increasing bin size) until the number of selected matches is equal to the focal set.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">mgr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchRanges.html">matchRanges</a></span><span class="op">(</span>focal <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   pool <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="op">!</span><span class="va">x</span><span class="op">$</span><span class="va">feature1</span><span class="op">]</span>,
                   covar <span class="op">=</span> <span class="op">~</span><span class="va">feature2</span> <span class="op">+</span> <span class="va">feature3</span>,
                   method <span class="op">=</span> <span class="st">'stratified'</span>,
                   replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/overview.html">overview</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotPropensity.html">plotPropensity</a></span><span class="op">(</span><span class="va">mgr</span><span class="op">)</span></code></pre></div>
<p><img src="matching_ranges_files/figure-html/unnamed-chunk-16-1.png"><!-- --></p>
<p>Stratified sampling is typically the slowest method since it involves iterative resampling. However, this is usually only noticable on very large datasets. Stratified sampling tends to work very well for discrete data, and often produces the best matches even on continuous data:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Extract difference in propensity scores</span>
<span class="co">## between focal and matched sets</span>
<span class="va">fmps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nn</span>, <span class="va">rs</span>, <span class="va">ss</span><span class="op">)</span>, <span class="va">`[[`</span>, <span class="st">"quality"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'nearest'</span>, <span class="st">'rejection'</span>, <span class="st">'stratified'</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="va">fmps</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] "stratified"</code></pre>
</div>
</div>
<div id="class-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#class-structure" class="anchor"></a>Class structure</h2>
<p>Since <code><a href="../reference/matchRanges.html">matchRanges()</a></code> automatically constructs the relevant classes, this section is not essential for using any of the <code>nullranges</code> package functionality. Instead, this section serves as a guide for developers who wish to extend these classes or those more interested in S4 implementation details.</p>
<div id="implementation-details" class="section level3">
<h3 class="hasAnchor">
<a href="#implementation-details" class="anchor"></a>Implementation details</h3>
<p><code><a href="../reference/matchRanges.html">matchRanges()</a></code> acts as a constructor, combining a <code>Matched</code> superclass - which contains the matching results - with either a <code>DataFrame</code>(<code>data.frame</code>/<code>data.table</code>), <code>GRanges</code>, or <code>GInteractions</code> superclass. This results in the <code>MatchedDataFrame</code>, <code>MatchedGRanges</code>, or <code>MatchedGInteractions</code> subclasses.</p>
<p><img src="images/class_structure.png" title="Class structure"></p>
<p>Internally, each <code>Matched</code> subclass uses a “delegate” object of the same type to assign its slots. The delegate object used is the <code>matched</code> set. Therefore, the resulting <code>Matched*</code> object behaves as a combination of both its superclasses - with access to methods from both.</p>
<p>For example, using <code><a href="../reference/matchRanges.html">matchRanges()</a></code> on <code>GRanges</code> objects assigns a <code>GRanges</code> delegate object which is used to populate GRanges-specific slots. This results in a <code>MatchedGRanges</code> object, with access to both <code>Matched</code> functions (e.g. <code>plotCovariate</code>) as well as normal <code>GRanges</code> methods (e.g.s <code>seqnames</code>, <code>resize</code>, etc…).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mikelove.github.io">Michael Love</a>, <a href="https://twitter.com/wancenm">Wancen Mu</a>, <a href="https://ericscottdavis.com">Eric Davis</a>, <a href="http://phanstiel-lab.med.unc.edu">Douglas Phanstiel</a>, <a href="https://stuartlee.org">Stuart Lee</a>, <a href="https://chanzuckerberg.com">CZI</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
